<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Budget Management System (FY2568)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9',
                            muted: '#94a3b8',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #0f172a;
            /* Slate 900 */
            color: #f1f5f9;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col">

    <!-- App Container -->
    <div id="app" class="flex-1 flex flex-col">
        <!-- Views will be injected here via JS -->
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // ==========================================
        // 1. MOCK DATA & STATE (Simulating Backend)
        // ==========================================

        const MOCK_DB = {
            users: [
                { email: 'admin@moj.go.th', password: 'admin123', name: 'ผู้ดูแลระบบสูงสุด', role: 'Admin', avatar: 'https://ui-avatars.com/api/?name=Admin&background=0ea5e9&color=fff' },
                { email: 'editor@moj.go.th', password: 'editor123', name: 'เจ้าหน้าที่บันทึก', role: 'Editor', avatar: 'https://ui-avatars.com/api/?name=Editor&background=10b981&color=fff' },
                { email: 'viewer@moj.go.th', password: 'viewer123', name: 'ผู้บริหาร (ดูอย่างเดียว)', role: 'Viewer', avatar: 'https://ui-avatars.com/api/?name=Viewer&background=f59e0b&color=fff' }
            ],
            budgets: [
                // Fiscal Year 2568 Data
                { id: 1, type: 'Personnel', category: 'เงินเดือนข้าราชการ', amount: 15000000, spent: 3750000, fiscal_year: 2568, updated_at: '2024-12-01' },
                { id: 2, type: 'Personnel', category: 'เงินประจำตำแหน่ง', amount: 2500000, spent: 620000, fiscal_year: 2568, updated_at: '2024-12-05' },
                { id: 3, type: 'Personnel', category: 'ค่าตอบแทนพิเศษ', amount: 1200000, spent: 150000, fiscal_year: 2568, updated_at: '2024-11-20' },
                { id: 4, type: 'Operations', category: 'ค่าเช่าบ้าน', amount: 3000000, spent: 800000, fiscal_year: 2568, updated_at: '2024-12-10' },
                { id: 5, type: 'Operations', category: 'เงินสมทบกองทุนประกันสังคม', amount: 800000, spent: 200000, fiscal_year: 2568, updated_at: '2024-11-30' },
                { id: 6, type: 'Operations', category: 'ค่ารักษาพยาบาล', amount: 5000000, spent: 1200000, fiscal_year: 2568, updated_at: '2024-12-08' },
                { id: 7, type: 'Personnel', category: 'ค่าล่วงเวลา', amount: 1000000, spent: 450000, fiscal_year: 2568, updated_at: '2024-12-11' },
                { id: 8, type: 'Subsidy', category: 'เงินอุดหนุนทั่วไป', amount: 10000000, spent: 2500000, fiscal_year: 2568, updated_at: '2024-10-15' },
            ]
        };

        const AppState = {
            currentUser: null,
            currentView: 'login', // login, dashboard, budget-list
            isSidebarOpen: true,

            // Helper to format currency
            formatCurrency: (value) => {
                return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(value);
            },

            // Helper to calculate percent
            calculatePercent: (spent, total) => {
                return total > 0 ? ((spent / total) * 100).toFixed(1) : 0;
            }
        };

        // ==========================================
        // 2. COMPONENT RENDERERS
        // ==========================================

        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (!AppState.currentUser) {
                app.appendChild(renderLoginView());
            } else {
                app.appendChild(renderMainLayout());
                initCharts(); // Initialize charts after rendering DOM
            }
        }

        function renderLoginView() {
            const container = document.createElement('div');
            container.className = 'flex min-h-screen items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4';

            container.innerHTML = `
                <div class="w-full max-w-md bg-dark-card border border-dark-border rounded-2xl shadow-2xl p-8 animate-fade-in-up">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-primary-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary-500/20">
                            <i class="ph ph-bank text-3xl text-white"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white mb-2">ระบบบริหารงบประมาณบุคลากร</h1>
                        <p class="text-dark-muted text-sm">กระทรวงยุติธรรม (Fiscal Year 2568)</p>
                    </div>

                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-dark-muted mb-1">อีเมล (@moj.go.th)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-dark-muted"><i class="ph ph-envelope"></i></span>
                                <input type="email" id="email" value="admin@moj.go.th" class="w-full bg-slate-800 border border-dark-border rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary-500 transition-colors" placeholder="name@moj.go.th">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-dark-muted mb-1">รหัสผ่าน</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-dark-muted"><i class="ph ph-lock"></i></span>
                                <input type="password" id="password" value="admin123" class="w-full bg-slate-800 border border-dark-border rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary-500 transition-colors" placeholder="••••••••">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-primary-600 hover:bg-primary-500 text-white font-semibold py-2.5 rounded-lg shadow-lg shadow-primary-500/20 transition-all duration-200 transform hover:scale-[1.02]">
                            เข้าสู่ระบบ
                        </button>
                    </form>

                    <div class="mt-6">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-dark-border"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-dark-card text-dark-muted">หรือเข้าสู่ระบบด้วย</span>
                            </div>
                        </div>

                        <button onclick="mockThaIDLogin()" class="mt-6 w-full bg-white text-slate-900 font-semibold py-2.5 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                            <img src="https://imauth.bora.dopa.go.th/images/thaid_logo.png" onerror="this.src='https://placehold.co/24x24?text=ID'" class="h-6 w-auto" alt="ThaID">
                            <span>ThaID (Mock)</span>
                        </button>
                    </div>

                    <div class="mt-8 p-4 bg-slate-800/50 rounded-lg border border-dashed border-dark-border text-xs text-dark-muted">
                        <p class="font-semibold mb-1">Demo Credentials:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <span>admin@moj.go.th</span> <span>admin123</span>
                            <span>editor@moj.go.th</span> <span>editor123</span>
                        </div>
                    </div>
                </div>
            `;

            // Attach Event Listeners
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleLogin();
                });
            } else {
                console.error('Login form element not found!');
            }

            return container;
        }

        function renderMainLayout() {
            const container = document.createElement('div');
            container.className = 'flex h-screen overflow-hidden bg-dark-bg text-white';

            // Sidebar
            const sidebarClass = AppState.isSidebarOpen ? 'w-64 translate-x-0' : 'w-64 -translate-x-full lg:translate-x-0 lg:w-20';

            container.innerHTML = `
                <!-- Mobile Overlay -->
                <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 lg:hidden ${AppState.isSidebarOpen ? 'block' : 'hidden'}"></div>

                <!-- Sidebar -->
                <aside class="fixed inset-y-0 left-0 z-30 flex flex-col bg-dark-card border-r border-dark-border transition-all duration-300 ${AppState.isSidebarOpen ? 'w-64' : 'w-0 lg:w-20'} overflow-hidden">
                    <div class="h-16 flex items-center px-6 border-b border-dark-border">
                        <i class="ph ph-bank text-3xl text-primary-500"></i>
                        <span class="ml-3 font-bold text-lg whitespace-nowrap ${AppState.isSidebarOpen ? 'opacity-100' : 'opacity-0 lg:hidden'} transition-opacity">HR Budget</span>
                    </div>

                    <nav class="flex-1 px-3 py-4 space-y-2 overflow-y-auto">
                        <a href="#" onclick="switchView('dashboard')" class="flex items-center px-3 py-2.5 rounded-lg ${AppState.currentView === 'dashboard' ? 'bg-primary-600 text-white' : 'text-dark-muted hover:bg-slate-800 hover:text-white'} transition-colors group">
                            <i class="ph ph-squares-four text-xl"></i>
                            <span class="ml-3 whitespace-nowrap ${AppState.isSidebarOpen ? 'block' : 'hidden lg:hidden'}">ภาพรวม (Dashboard)</span>
                            <!-- Tooltip for collapsed -->
                            <div class="${!AppState.isSidebarOpen ? 'lg:block hidden' : 'hidden'} absolute left-16 bg-slate-800 text-xs px-2 py-1 rounded ml-2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">ภาพรวม</div>
                        </a>
                        
                        <a href="#" onclick="switchView('budget-list')" class="flex items-center px-3 py-2.5 rounded-lg ${AppState.currentView === 'budget-list' ? 'bg-primary-600 text-white' : 'text-dark-muted hover:bg-slate-800 hover:text-white'} transition-colors group">
                            <i class="ph ph-table text-xl"></i>
                            <span class="ml-3 whitespace-nowrap ${AppState.isSidebarOpen ? 'block' : 'hidden lg:hidden'}">รายการงบประมาณ</span>
                             <div class="${!AppState.isSidebarOpen ? 'lg:block hidden' : 'hidden'} absolute left-16 bg-slate-800 text-xs px-2 py-1 rounded ml-2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">รายการงบประมาณ</div>
                        </a>

                        <div class="pt-4 mt-4 border-t border-dark-border">
                            <div class="px-3 mb-2 text-xs font-semibold text-dark-muted uppercase tracking-wider ${AppState.isSidebarOpen ? 'block' : 'hidden'}">รายงาน</div>
                            <a href="#" class="flex items-center px-3 py-2.5 rounded-lg text-dark-muted hover:bg-slate-800 hover:text-white transition-colors group">
                                <i class="ph ph-chart-line-up text-xl"></i>
                                <span class="ml-3 whitespace-nowrap ${AppState.isSidebarOpen ? 'block' : 'hidden lg:hidden'}">การเบิกจ่ายรายเดือน</span>
                            </a>
                            <a href="#" class="flex items-center px-3 py-2.5 rounded-lg text-dark-muted hover:bg-slate-800 hover:text-white transition-colors group">
                                <i class="ph ph-file-pdf text-xl"></i>
                                <span class="ml-3 whitespace-nowrap ${AppState.isSidebarOpen ? 'block' : 'hidden lg:hidden'}">ส่งออกรายงาน (PDF)</span>
                            </a>
                        </div>
                    </nav>

                    <div class="p-4 border-t border-dark-border">
                        <button onclick="handleLogout()" class="flex items-center w-full px-3 py-2 text-red-400 hover:bg-red-900/20 rounded-lg transition-colors group">
                            <i class="ph ph-sign-out text-xl"></i>
                            <span class="ml-3 whitespace-nowrap ${AppState.isSidebarOpen ? 'block' : 'hidden lg:hidden'}">ออกจากระบบ</span>
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col transition-all duration-300 ${AppState.isSidebarOpen ? 'ml-64' : 'ml-0 lg:ml-20'}">
                    <!-- Topbar -->
                    <header class="h-16 bg-dark-card/80 backdrop-blur border-b border-dark-border flex items-center justify-between px-6 sticky top-0 z-20">
                        <div class="flex items-center">
                            <button onclick="toggleSidebar()" class="text-dark-muted hover:text-white p-2 rounded-lg hover:bg-slate-800 mr-4">
                                <i class="ph ph-list text-2xl"></i>
                            </button>
                            <h2 class="text-lg font-semibold text-white hidden sm:block">
                                ${AppState.currentView === 'dashboard' ? 'ภาพรวมงบประมาณ ปี 2568' : 'จัดการรายการงบประมาณ'}
                            </h2>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-3">
                                <div class="text-right hidden sm:block">
                                    <div class="text-sm font-medium text-white">${AppState.currentUser.name}</div>
                                    <div class="text-xs text-dark-muted">${AppState.currentUser.role}</div>
                                </div>
                                <img src="${AppState.currentUser.avatar}" alt="User" class="w-10 h-10 rounded-full border border-dark-border">
                            </div>
                        </div>
                    </header>

                    <!-- Page Content -->
                    <main class="flex-1 overflow-y-auto bg-dark-bg p-6">
                        ${AppState.currentView === 'dashboard' ? getDashboardContent() : getBudgetListContent()}
                    </main>
                </div>
            `;
            return container;
        }

        function getDashboardContent() {
            // Calculate Stats
            const totalBudget = MOCK_DB.budgets.reduce((sum, item) => sum + item.amount, 0);
            const totalSpent = MOCK_DB.budgets.reduce((sum, item) => sum + item.spent, 0);
            const remaining = totalBudget - totalSpent;
            const percentage = AppState.calculatePercent(totalSpent, totalBudget);

            return `
                <div class="space-y-6 animate-fade-in">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-dark-card border border-dark-border rounded-xl p-6 shadow-sm hover:border-primary-500/50 transition-colors">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-dark-muted text-sm font-medium">งบประมาณได้รับจัดสรร</p>
                                    <h3 class="text-2xl font-bold text-white mt-1">${AppState.formatCurrency(totalBudget)}</h3>
                                </div>
                                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                                    <i class="ph ph-wallet text-2xl"></i>
                                </div>
                            </div>
                            <div class="text-xs text-green-400 flex items-center">
                                <i class="ph ph-trend-up mr-1"></i> +5% จากปีที่แล้ว
                            </div>
                        </div>

                        <div class="bg-dark-card border border-dark-border rounded-xl p-6 shadow-sm hover:border-primary-500/50 transition-colors">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-dark-muted text-sm font-medium">เบิกจ่ายแล้ว</p>
                                    <h3 class="text-2xl font-bold text-white mt-1">${AppState.formatCurrency(totalSpent)}</h3>
                                </div>
                                <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500">
                                    <i class="ph ph-money text-2xl"></i>
                                </div>
                            </div>
                            <div class="w-full bg-slate-700 h-1.5 rounded-full mt-2">
                                <div class="bg-orange-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="text-xs text-dark-muted mt-2">${percentage}% ของงบทั้งหมด</div>
                        </div>

                        <div class="bg-dark-card border border-dark-border rounded-xl p-6 shadow-sm hover:border-primary-500/50 transition-colors">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-dark-muted text-sm font-medium">คงเหลือ</p>
                                    <h3 class="text-2xl font-bold text-green-400 mt-1">${AppState.formatCurrency(remaining)}</h3>
                                </div>
                                <div class="p-2 bg-green-500/10 rounded-lg text-green-500">
                                    <i class="ph ph-piggy-bank text-2xl"></i>
                                </div>
                            </div>
                             <div class="text-xs text-dark-muted mt-2">เพียงพอสำหรับ 9 เดือน</div>
                        </div>

                        <div class="bg-dark-card border border-dark-border rounded-xl p-6 shadow-sm hover:border-primary-500/50 transition-colors">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-dark-muted text-sm font-medium">เป้าหมายไตรมาส 1</p>
                                    <h3 class="text-2xl font-bold text-white mt-1">32%</h3>
                                </div>
                                <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                                    <i class="ph ph-target text-2xl"></i>
                                </div>
                            </div>
                            <div class="text-xs text-green-400 flex items-center">
                                <i class="ph ph-check-circle mr-1"></i> สูงกว่าเป้า (27%)
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Spending Trend -->
                        <div class="lg:col-span-2 bg-dark-card border border-dark-border rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">แนวโน้มการเบิกจ่าย (Timeline)</h3>
                            <div class="h-64 relative w-full">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>

                        <!-- Category Breakdown -->
                        <div class="bg-dark-card border border-dark-border rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">สัดส่วนตามประเภทงบ</h3>
                            <div class="h-64 relative w-full flex justify-center">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-dark-card border border-dark-border rounded-xl overflow-hidden">
                        <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-white">กิจกรรมล่าสุด</h3>
                            <button class="text-sm text-primary-500 hover:text-primary-400">ดูทั้งหมด</button>
                        </div>
                        <div class="divide-y divide-dark-border">
                            <div class="p-4 hover:bg-slate-800/50 transition-colors flex items-center gap-4">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-white">นำเข้าข้อมูล CSV ประจำเดือนธันวาคม</p>
                                    <p class="text-xs text-dark-muted">โดย Admin • 2 นาทีที่แล้ว</p>
                                </div>
                            </div>
                             <div class="p-4 hover:bg-slate-800/50 transition-colors flex items-center gap-4">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-white">แก้ไขงบประมาณ "ค่าเช่าบ้าน"</p>
                                    <p class="text-xs text-dark-muted">โดย Editor • 1 ชั่วโมงที่แล้ว</p>
                                </div>
                            </div>
                             <div class="p-4 hover:bg-slate-800/50 transition-colors flex items-center gap-4">
                                <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-white">อนุมัติการโอนเปลี่ยนแปลงงบประมาณ</p>
                                    <p class="text-xs text-dark-muted">โดย Approver • 3 ชั่วโมงที่แล้ว</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBudgetListContent() {
            // Generate table rows based on MOCK_DB
            const rows = MOCK_DB.budgets.map(item => {
                const percent = AppState.calculatePercent(item.spent, item.amount);
                const progressColor = percent > 80 ? 'bg-red-500' : percent > 50 ? 'bg-orange-500' : 'bg-green-500';

                return `
                    <tr class="hover:bg-slate-800/50 transition-colors border-b border-dark-border last:border-0">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-medium">${item.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-muted">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.type === 'Personnel' ? 'bg-blue-500/10 text-blue-400' : 'bg-purple-500/10 text-purple-400'}">
                                ${item.type === 'Personnel' ? 'บุคลากร' : (item.type === 'Operations' ? 'ดำเนินงาน' : 'อุดหนุน')}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">${AppState.formatCurrency(item.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-dark-muted">${AppState.formatCurrency(item.spent)}</td>
                        <td class="px-6 py-4 whitespace-nowrap align-middle">
                            <div class="w-full bg-slate-700 h-1.5 rounded-full">
                                <div class="${progressColor} h-1.5 rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <div class="text-xs text-right mt-1 text-dark-muted">${percent}%</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="showToast('ฟีเจอร์แก้ไข (Edit) ยังไม่เปิดใช้งานใน Demo', 'info')" class="text-primary-500 hover:text-primary-400 mx-1"><i class="ph ph-pencil-simple"></i></button>
                            <button onclick="deleteBudget(${item.id})" class="text-red-500 hover:text-red-400 mx-1"><i class="ph ph-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="space-y-6 animate-fade-in">
                    <!-- Actions Toolbar -->
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-dark-card border border-dark-border p-4 rounded-xl">
                        <div class="relative w-full sm:w-64">
                            <span class="absolute left-3 top-2.5 text-dark-muted"><i class="ph ph-magnifying-glass"></i></span>
                            <input type="text" placeholder="ค้นหารายการ..." class="w-full bg-slate-800 border border-dark-border rounded-lg py-2 pl-10 pr-4 text-white text-sm focus:outline-none focus:border-primary-500 transition-colors">
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button class="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg border border-dark-border transition-colors text-sm">
                                <i class="ph ph-file-csv"></i> Import CSV
                            </button>
                            <button onclick="addNewBudget()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-primary-600 hover:bg-primary-500 text-white px-4 py-2 rounded-lg shadow-lg shadow-primary-500/20 transition-colors text-sm">
                                <i class="ph ph-plus"></i> เพิ่มรายการ
                            </button>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="bg-dark-card border border-dark-border rounded-xl overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-dark-border">
                                <thead class="bg-slate-800/50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">หมวดรายจ่าย</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">ประเภท</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-dark-muted uppercase tracking-wider">งบจัดสรร</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-dark-muted uppercase tracking-wider">เบิกจ่ายแล้ว</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-dark-muted uppercase tracking-wider w-32">ความคืบหน้า</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-dark-muted uppercase tracking-wider">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-dark-border bg-dark-card">
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <div class="bg-dark-card px-6 py-4 border-t border-dark-border flex items-center justify-between">
                            <div class="text-xs text-dark-muted">แสดง 1 ถึง ${MOCK_DB.budgets.length} จาก ${MOCK_DB.budgets.length} รายการ</div>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 rounded bg-slate-800 text-dark-muted hover:text-white disabled:opacity-50" disabled>ก่อนหน้า</button>
                                <button class="px-3 py-1 rounded bg-slate-800 text-dark-muted hover:text-white disabled:opacity-50" disabled>ถัดไป</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 3. LOGIC & HANDLERS
        // ==========================================

        function handleLogin() {
            try {
                const email = document.getElementById('email');
                const password = document.getElementById('password');

                if (!email || !password) {
                    console.error('Email or password input elements not found');
                    return;
                }

                const emailValue = email.value;
                const passwordValue = password.value;

                console.log('Login attempt:', { email: emailValue, password: '***' });

                // Simple mock auth logic
                const user = MOCK_DB.users.find(u => u.email === emailValue && u.password === passwordValue);

                if (user) {
                    console.log('Login successful:', user);
                    AppState.currentUser = user;
                    showToast(`ยินดีต้อนรับ ${user.name}`, 'success');
                    renderApp();
                } else {
                    console.log('Login failed');
                    showToast('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                }
            } catch (error) {
                console.error('Error in handleLogin:', error);
                showToast('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
            }
        }

        function mockThaIDLogin() {
            // Simulate ThaID flow
            showToast('กำลังเชื่อมต่อ ThaID...', 'info');
            setTimeout(() => {
                // Login as generic user
                const user = { email: 'somchai@moj.go.th', name: 'นายสมชาย ใจดี (ThaID)', role: 'Viewer', avatar: 'https://ui-avatars.com/api/?name=Somchai&background=random' };
                AppState.currentUser = user;
                showToast('เข้าสู่ระบบผ่าน ThaID สำเร็จ', 'success');
                renderApp();
            }, 1500);
        }

        function handleLogout() {
            AppState.currentUser = null;
            AppState.currentView = 'login';
            renderApp();
            showToast('ออกจากระบบเรียบร้อยแล้ว', 'info');
        }

        function switchView(viewName) {
            AppState.currentView = viewName;

            // On mobile, close sidebar after switching
            if (window.innerWidth < 1024) {
                AppState.isSidebarOpen = false;
            }

            renderApp();
        }

        function toggleSidebar() {
            AppState.isSidebarOpen = !AppState.isSidebarOpen;
            renderApp();
        }

        function addNewBudget() {
            // Simulate adding a record
            const newId = MOCK_DB.budgets.length + 1;
            MOCK_DB.budgets.unshift({
                id: newId,
                type: 'Operations',
                category: 'รายการใหม่ (New Entry)',
                amount: 100000,
                spent: 0,
                fiscal_year: 2568,
                updated_at: new Date().toISOString().split('T')[0]
            });
            showToast('เพิ่มรายการใหม่สำเร็จ', 'success');
            renderApp();
        }

        function deleteBudget(id) {
            if (confirm('ยืนยันการลบรายการนี้?')) {
                MOCK_DB.budgets = MOCK_DB.budgets.filter(b => b.id !== id);
                showToast('ลบรายการสำเร็จ', 'success');
                renderApp();
            }
        }

        function initCharts() {
            if (AppState.currentView !== 'dashboard') return;

            // Chart Configuration Defaults
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.font.family = '"Noto Sans Thai", sans-serif';

            // 1. Trend Chart (Line)
            const ctxTrend = document.getElementById('trendChart')?.getContext('2d');
            if (ctxTrend) {
                new Chart(ctxTrend, {
                    type: 'line',
                    data: {
                        labels: ['ต.ค.', 'พ.ย.', 'ธ.ค.', 'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.'],
                        datasets: [
                            {
                                label: 'เป้าหมายสะสม',
                                data: [8, 16, 25, 33, 41, 50, 58, 66, 75],
                                borderColor: '#64748b',
                                borderDash: [5, 5],
                                tension: 0.4
                            },
                            {
                                label: 'เบิกจ่ายจริง',
                                data: [5, 12, 28, 35, null, null, null, null, null], // Mock data ending at Jan
                                borderColor: '#0ea5e9',
                                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: {
                                grid: { color: '#334155' },
                                beginAtZero: true
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // 2. Category Chart (Doughnut)
            const ctxCategory = document.getElementById('categoryChart')?.getContext('2d');
            if (ctxCategory) {
                // Group data by type
                const personnelTotal = MOCK_DB.budgets.filter(b => b.type === 'Personnel').reduce((sum, b) => sum + b.amount, 0);
                const operationsTotal = MOCK_DB.budgets.filter(b => b.type === 'Operations').reduce((sum, b) => sum + b.amount, 0);
                const subsidyTotal = MOCK_DB.budgets.filter(b => b.type === 'Subsidy').reduce((sum, b) => sum + b.amount, 0);

                new Chart(ctxCategory, {
                    type: 'doughnut',
                    data: {
                        labels: ['บุคลากร', 'ดำเนินงาน', 'อุดหนุน'],
                        datasets: [{
                            data: [personnelTotal, operationsTotal, subsidyTotal],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        cutout: '70%'
                    }
                });
            }
        }

        // Helper: Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let bgClass = 'bg-slate-800';
            let icon = '<i class="ph ph-info"></i>';

            if (type === 'success') { bgClass = 'bg-green-600'; icon = '<i class="ph ph-check-circle"></i>'; }
            if (type === 'error') { bgClass = 'bg-red-600'; icon = '<i class="ph ph-warning"></i>'; }

            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0`;
            toast.innerHTML = `${icon} <span class="text-sm font-medium">${message}</span>`;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize
        try {
            console.log('Initializing HR Budget System...');
            renderApp();
            console.log('HR Budget System initialized successfully');
        } catch (error) {
            console.error('Failed to initialize HR Budget System:', error);
            // Show error in UI if possible
            const app = document.getElementById('app');
            if (app) {
                app.innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center text-red-400">
                            <h1 class="text-xl font-bold mb-2">เกิดข้อผิดพลาดในการเริ่มต้นระบบ</h1>
                            <p>โปรดตรวจสอบ Console สำหรับรายละเอียดเพิ่มเติม</p>
                        </div>
                    </div>
                `;
            }
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024 && !AppState.isSidebarOpen) {
                // Don't auto-open sidebar on resize to avoid annoyance, but keep layout responsive
            }
            renderApp(); // Re-render to adjust layout classes
        });

    </script>
</body>

</html>

