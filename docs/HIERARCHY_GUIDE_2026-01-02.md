# ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Hierarchy: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢

[TOC]


**‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ:** ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ (Sub-projects) ‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ (Sub-activities)  
**‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:** 2026-01-02 (Updated: 21:30)  
**Migration:** [`052_add_hierarchy_projects_activities.sql`](file:///C:/laragon/www/hr_budget/database/migrations/052_add_hierarchy_projects_activities.sql)  
**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‚úÖ **‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Production Ready)**

---

## üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£

‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö **‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (Hierarchy)**:

‚úÖ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ  
‚úÖ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ  
‚úÖ ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö (Unlimited Depth)  
‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ (Backward Compatible)

---

## üîó ‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Entity Relationship)

```mermaid
erDiagram
    PROJECTS ||--o{ PROJECTS : "parent_id"
    ACTIVITIES ||--o{ ACTIVITIES : "parent_id"
    PROJECTS ||--o{ ACTIVITIES : "project_id"
    
    PROJECTS {
        int id PK
        int parent_id FK "Self-reference"
        int level "0=Root, 1=Sub..."
        varchar name_th
        int plan_id FK
    }
    
    ACTIVITIES {
        int id PK
        int parent_id FK "Self-reference"
        int level "0=Root, 1=Sub..."
        varchar name_th
        int project_id FK
    }
```

---

## üéØ ‡∏Å‡∏£‡∏ì‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Use Cases)

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà
```
üìÅ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (‡∏á‡∏ö 10M)
  ‚îú‚îÄ üìÅ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢: ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏á‡∏ö 6M)
  ‚îÇ   ‚îú‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
  ‚îÇ   ‚îî‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ‡∏û‡∏±‡∏í‡∏ô‡∏≤ Application
  ‚îî‚îÄ üìÅ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢: ‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ (‡∏á‡∏ö 4M)
      ‚îú‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
      ‚îî‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
```

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
```
üìÑ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤
  ‚îú‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£
  ‚îú‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢: ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  ‚îî‚îÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢: ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•
```

---

## üîß ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### ‡∏ï‡∏≤‡∏£‡∏≤‡∏á `projects`
| Column | Type | Description |
|--------|------|-------------|
| `id` | INT | ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ |
| `parent_id` | INT (NULL) | ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πà (NULL = ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å) |
| `level` | INT | ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (0 = ‡∏´‡∏•‡∏±‡∏Å, 1 = ‡∏¢‡πà‡∏≠‡∏¢, 2 = ‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢) |
| `name_th` | VARCHAR | ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ |

### ‡∏ï‡∏≤‡∏£‡∏≤‡∏á `activities`
| Column | Type | Description |
|--------|------|-------------|
| `id` | INT | ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° |
| `parent_id` | INT (NULL) | ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏°‡πà (NULL = ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å) |
| `level` | INT | ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å |
| `name_th` | VARCHAR | ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° |

---

## üõ°Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Safeguards)

### 1. ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ö‡∏±‡∏á‡πÄ‡∏≠‡∏¥‡∏ç
```sql
ON DELETE RESTRICT  -- ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏≠‡∏¢‡∏π‡πà
```

### 2. ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ß‡∏á‡∏ß‡∏ô (Circular Reference)
- Trigger ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö **‡∏•‡∏∂‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏∞‡∏î‡∏±‡∏ö** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô infinite loop
- ‡∏ñ‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏° ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

### 3. ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
```sql
-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å
INSERT INTO projects (name_th, parent_id) VALUES ('‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ A', NULL);
SET @parent_id = LAST_INSERT_ID();
INSERT INTO projects (name_th, parent_id) VALUES ('‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ A.1', @parent_id);
SET @child_id = LAST_INSERT_ID();

-- ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å)
UPDATE projects SET parent_id = @child_id WHERE id = @parent_id;
-- ERROR: Circular reference detected in project hierarchy.
```

---

## üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πà‡∏≠‡∏¢

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏ú‡πà‡∏≤‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (SQL)
```sql
-- 1. ‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πà
SELECT id, name_th FROM projects WHERE name_th LIKE '%‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•%';

-- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà
INSERT INTO projects (name_th, parent_id, level) 
VALUES ('‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢: ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠', 5, 1);
```

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ú‡πà‡∏≤‡∏ô Admin UI (‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
- Tree View ‡πÅ‡∏ö‡∏ö Drag & Drop
- ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢" ‡πÉ‡∏ï‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£

---

## üìä ‡∏Å‡∏≤‡∏£ Query ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### 1. ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
```sql
WITH RECURSIVE project_tree AS (
    SELECT id, name_th, parent_id, level, CAST(name_th AS CHAR(1000)) AS path
    FROM projects WHERE parent_id IS NULL
    UNION ALL
    SELECT p.id, p.name_th, p.parent_id, p.level, CONCAT(pt.path, ' > ', p.name_th)
    FROM projects p
    INNER JOIN project_tree pt ON p.parent_id = pt.id
)
SELECT * FROM project_tree ORDER BY path;
```

### 2. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢
```sql
SELECT parent.id, parent.name_th, COUNT(child.id) AS sub_count
FROM projects parent
LEFT JOIN projects child ON child.parent_id = parent.id
GROUP BY parent.id HAVING sub_count > 0;
```

> ‚ö†Ô∏è **Performance Note:** Recursive CTE ‡∏≠‡∏≤‡∏à‡∏ä‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
> - ‡πÄ‡∏û‡∏¥‡πà‡∏° INDEX ‡∏ö‡∏ô `parent_id` (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
> - ‡∏à‡∏≥‡∏Å‡∏±‡∏î depth ‡∏î‡πâ‡∏ß‡∏¢ `WHERE level <= 3`
> - ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ Materialized Path (`/1/5/12`) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö read-heavy scenarios

---

## üì• ‡∏Å‡∏≤‡∏£ Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CSV

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
**CSV ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢** ‚Üí ‡πÉ‡∏ä‡πâ Script Import v3 ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥

### ‡πÅ‡∏ú‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (‡πÄ‡∏°‡∏∑‡πà‡∏≠ CSV ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πà‡∏≠‡∏¢)

#### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á CSV Format:
```csv
project_code,project_name,parent_project_code,level
P001,‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•,,0
P001-01,‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢: ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á,P001,1
P001-02,‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢: ‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ,P001,1
```

#### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á PHP Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Import:
```php
function importProjectWithHierarchy(PDO $pdo, array $row, array &$cache): int {
    // ‡∏´‡∏≤ parent_id ‡∏à‡∏≤‡∏Å code
    $parentId = null;
    if (!empty($row['parent_project_code'])) {
        $parentId = $cache['projects_by_code'][$row['parent_project_code']] ?? null;
        if ($parentId === null) {
            throw new Exception("Parent code not found: " . $row['parent_project_code']);
        }
    }
    
    // Insert project
    $stmt = $pdo->prepare("
        INSERT INTO projects (code, name_th, parent_id, level) 
        VALUES (?, ?, ?, ?)
    ");
    $stmt->execute([
        $row['project_code'],
        $row['project_name'],
        $parentId,
        $row['level'] ?? 0
    ]);
    
    $projectId = $pdo->lastInsertId();
    $cache['projects_by_code'][$row['project_code']] = $projectId;
    
    return $projectId;
}
```

---

## ‚ùì FAQ

| ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° | ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö |
|-------|-------|
| ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°? | ‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 100% (Backward Compatible) |
| ‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°? | ‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô (Safety First) |
| ‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°? | ‚úÖ ‡πÑ‡∏î‡πâ (`UPDATE parent_id`) |
| ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô? | ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô - ‡πÅ‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ |
| KPI ‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏´‡∏°? | ‚è≥ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Recursive Query (‡∏£‡∏≠ View ‡∏û‡∏¥‡πÄ‡∏®‡∏©) |

---

## üìö Version History
| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-01 | Initial hierarchy implementation |
| 1.1 | 2026-01-02 21:30 | Added ER diagram, performance note, FAQ |
| 1.2 | 2026-01-02 21:33 | Added TOC, language tags, version history |

## üîÆ ‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠ (Roadmap)

| Phase | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î |
|-------|-------|-----------|
| **Phase 1: Database** | ‚úÖ | Schema, Triggers, Constraints |
| **Phase 2: Import Script** | ‚è≥ | ‡∏£‡∏≠ CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πà‡∏≠‡∏¢ |
| **Phase 3: Admin UI** | üìã | Tree View, Drag & Drop |
| **Phase 4: Dashboard** | üìã | ‡πÅ‡∏™‡∏î‡∏á Hierarchy ‡πÅ‡∏ö‡∏ö Expandable |
| **Phase 5: KPI Rollup** | üìã | ‡∏£‡∏ß‡∏°‡∏ú‡∏• KPI ‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡πÑ‡∏õ‡∏´‡∏≤‡πÅ‡∏°‡πà |

---

## üìû ‡∏™‡∏£‡∏∏‡∏õ

‚úÖ **‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß** - ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô SQL ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ  
‚úÖ **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢** - ‡∏°‡∏µ Safeguards ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Circular check 10 levels)  
‚úÖ **Backward Compatible** - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö  

**Migration File:** [`052_add_hierarchy_projects_activities.sql`](file:///C:/laragon/www/hr_budget/database/migrations/052_add_hierarchy_projects_activities.sql)

---

**‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠:** 2026-01-02 21:30  
**‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥:** Antigravity AI Assistant
